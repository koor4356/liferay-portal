<?xml version="1.0"?>

<project basedir="." name="portal-test-gogo-shell" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<macrodef name="get-gogo-shell-client-paths">
		<sequential>
			<property name="project.dir.home" value="${project.dir}" />
		</sequential>
	</macrodef>

	<target name="enable-access-to-gogo-shell-command">
		<parallel failonany="true">
			<antcall inheritAll="false" target="prepare-log4j-ext-xml" />

			<antcall inheritAll="false" target="prepare-portal-ext-properties" />

			<antcall inheritall="false" target="start-app-server" />

			<sequential>
				<waitfor maxwait="300" maxwaitunit="second" timeoutproperty="contents">
					<resourcecontains
						resource="${project.dir.home}"
						substring="http://localhost:8080/web/guest has loaded"
					/>
				</waitfor>

				<echo message="${contents}" />

				<sleep seconds="5" />

				<exec executable="/bin/bash" outputproperty="gogo.shell.content.output">
					<arg value="-c" />
					<arg value="telnet localhost 11312 > gogo.shell.result.output" />
				</exec>

				<loadfile
					property="gogo.shell.content.output"
					srcFile="gogo.shell.result.output"
				/>

				<echo>${gogo.shell.content.output}</echo>

				<if>
					<contains string="${gogo.shell.content.output}" substring="Connected to localhost." />
					<then>
						<echo message="PASSED. 'Connected to localhost.' is present." />
					</then>
					<else>
						<fail message="FAILED. 'Connected to localhost.' is not present." />
					</else>
				</if>

				<delete file="gogo.shell.result.output" />
			</sequential>
		</parallel>
	</target>

	<target name="no-default-access-to-gogo-shell-command">
		<parallel failonany="true">
			<antcall inheritAll="false" target="prepare-log4j-ext-xml" />

			<antcall inheritAll="false" target="prepare-portal-ext-properties" />

			<antcall inheritall="false" target="start-app-server" />

			<sequential>
				<waitfor maxwait="300" maxwaitunit="second" timeoutproperty="contents">
					<resourcecontains
						resource="${project.dir.home}"
						substring="http://localhost:8080/web/guest has loaded"
					/>
				</waitfor>

				<echo message="${contents}" />

				<sleep seconds="5" />

				<exec executable="/bin/bash" outputproperty="gogo.shell.content.output">
					<arg value="-c" />
					<arg value="telnet localhost 11311 > gogo.shell.result.output" />
				</exec>

				<loadfile
					property="gogo.shell.content.output"
					srcFile="gogo.shell.result.output"
				/>

				<echo>${gogo.shell.content.output}</echo>

				<if>
					<contains string="${gogo.shell.content.output}" substring="telnet: connect to address 127.0.0.1: Connection refused" />
					<then>
						<echo message="PASSED. 'telnet: connect to address 127.0.0.1: Connection refused' is present." />
					</then>
					<else>
						<fail message="FAILED. 'telnet: connect to address 127.0.0.1: Connection refused' is not present." />
					</else>
				</if>

				<delete file="gogo.shell.result.output" />
			</sequential>
		</parallel>
	</target>
</project>